# SPDX-FileCopyrightText: 2022 Helmholtz-Zentrum hereon GmbH (hereon)#
# SPDX-License-Identifier: CC-BY-4.0
# SPDX-FileContributor: Carsten Lemmen <carsten.lemmen@hereon.de>

include :
  - .gitlab/license.yaml
  - .gitlab/docker.yaml
  - .gitlab/joss.yaml
  - .gitlab/odd.yaml

stages:
  - lint
  - run
  - test
  - deploy

unit-tests:
  image: comses/netlogo # see https://github.com/comses/docker-netlogo
  stage: test
  script:
    - echo "Trying to run in working directory and headless mode"
    - echo "Java HOME is ${JAVA_HOME}"
    - cd ${CI_PROJECT_DIR}/netlogo
    - sed  -i 's/^NetLogo 6..../NetLogo 6.2.2/g' abm_fisheries_mussel.nlogo
    - > 
      bash /opt/netlogo/netlogo-headless.sh 
      --model ./abm_fisheries_mussel.nlogo 
      --setup-file ./behavior/unit-tests.xml
      --experiment "unit-tests" --table -
  allow_failure: false
  needs: []
  
# create-map:
#   image: comses/netlogo # see https://github.com/comses/docker-netlogo
#   stage: run
#   before_script:
#     - echo "Nothing done here."
#   script:
#     - echo "Trying to run in working directory and headless mode"
#     - echo "Java HOME is ${JAVA_HOME}"
#     - cd ${CI_PROJECT_DIR}/netlogo
#     - > 
#       bash /opt/netlogo/netlogo-headless.sh 
#       --model ./abm_fisheries_mussel.nlogo 
#       --setup-file ./behavior/effort-map.xml
#       --experiment "effort-map" --table -
  
  # Preserve resulting files
  # artifacts:
  #   paths: 
  #     - ./netlogo/results/
  # needs: []

pages: # predefined name by GitLab
    stage: deploy
    script:
        - mkdir -p public # required by GitLab
        - touch public/index.html
        #- mv ./netlogo/results/*.png public/
        - cp ./doc/odd/paper.pdf public/odd.pdf
        - cp ./doc/joss/paper.pdf public/joss.pdf
    rules:
        - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    artifacts:
        paths:
            - public/
    needs: 
      - joss-paper
      - odd-paper
    #  - create-map



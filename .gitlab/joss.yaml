# GitLab CI configuration file for building the JOSS paper
#
# SPDX-FileCopyrightText: 2022-2023 Helmholtz-Zentrum hereon
# SPDX-License-Identifier: CC0-1.0
# SPDX-FileContributor Carsten Lemmen <carsten.lemmen@hereon.de

joss-paper:
    image: $CI_REGISTRY_IMAGE/pandoc:latest
    script:
      - joss -p -o pdf doc/joss/paper.md
    artifacts:
      paths:
        - doc/joss/paper.pdf
    needs: []
    stage: deploy

# This one does not work for bugs in inara upstream,
# https://github.com/openjournals/inara/issues/34
joss-inara:
  stage: deploy
  image: 'openjournals/inara'
  variables:
    GIT_SHA: $CI_COMMIT_SHA
    GIT_STRATEGY: none # prevent cloning
    JOURNAL: joss
  before_script:
    - git clone --depth=1 ${CI_REPOSITORY_URL} ./vinos
  script:
    - inara -o pdf,cff ./vinos/doc/joss/paper.md
  environment:
    name: draft
  when: manual
  allow_failure: false
  artifacts:
    paths:
      - ./vinos/doc/joss/paper.pdf
  needs: []

# This one actually runs (but takes much longer)
# joss-docker:
#     image: docker
#     tags: ["docker", "dind"]
#     services:
#         - docker:dind
#     variables:
#         CONTAINER_REGISTRY_IMAGE: $CI_REGISTRY_IMAGE/pandoc:latest
#     allow_failure: false
#     interruptible: true
#     stage: deploy

#     before_script:
#         - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
#     script:
#         - docker pull ${CONTAINER_REGISTRY_IMAGE}
#         - docker run -v $(pwd):/data ${CONTAINER_REGISTRY_IMAGE} joss /data/doc/joss/paper.md
#     needs: []

#     artifacts:
#       paths:
#         - doc/joss/paper.pdf
#     needs: []
